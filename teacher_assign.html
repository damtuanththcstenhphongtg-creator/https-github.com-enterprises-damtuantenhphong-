<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Giao b√†i n√¢ng cao ‚Äì Load t·ª´ m√°y</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Th∆∞ vi·ªán xu·∫•t Word client-side -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/docx/7.3.0/docx.min.js"></script>

<style>
body { font-family: "Segoe UI", sans-serif; background: #eef3f7; margin:0; padding:0; }
.wrap { max-width:1000px; margin:30px auto; background:#fff; padding:25px; border-radius:12px; box-shadow:0 4px 14px rgba(0,0,0,0.18); }
h1 { text-align:center; color:#0a4a8e; }
label { font-weight:600; margin-top:12px; display:block; }
select,input { width:100%; padding:10px; margin-top:6px; border:1px solid #c7d7e4; border-radius:8px; font-size:16px; }
button { background:#0b74d1; color:#fff; padding:12px 20px; margin-top:15px; border:none; border-radius:8px; cursor:pointer; font-size:16px; }
button:hover { background:#095ba8; }
.back-btn { background:#888; }
.back-btn:hover { background:#666; }
.success { background:#e1fbd8; padding:12px; border-left:5px solid #4caf50; border-radius:8px; margin-top:15px; }
.error { background:#ffe2e2; padding:12px; border-left:5px solid #e53935; border-radius:8px; margin-top:15px; }
#assignedList { margin-top:30px; }
#assignedList table { width:100%; border-collapse:collapse; margin-top:10px; }
#assignedList th,#assignedList td { border:1px solid #ccc; padding:8px; text-align:center; }
#assignedList th { background-color:#3498db; color:#fff; }
tr:nth-child(even){background:#f9f9f9;}
</style>
</head>

<body>
<div class="wrap">

    <button class="back-btn" onclick="window.location.href='teacher_dashboard.html'">‚Üê Quay l·∫°i</button>

    <h1>üìù GIAO B√ÄI N√ÇNG CAO (T·ª™ M√ÅY)</h1>

    <div id="msg"></div>

    <label>Ch·ªçn file ƒë·ªÅ ki·ªÉm tra (JSON):</label>
    <input type="file" id="fileExam" accept=".json">

    <label>Ch·ªçn l·ªõp giao b√†i:</label>
    <select id="assignClass">
        <option value="6A">L·ªõp 6A</option>
        <option value="6B">L·ªõp 6B</option>
        <option value="7A">L·ªõp 7A</option>
        <option value="7B">L·ªõp 7B</option>
        <option value="8A">L·ªõp 8A</option>
        <option value="8B">L·ªõp 8B</option>
        <option value="9A">L·ªõp 9A</option>
        <option value="9B">L·ªõp 9B</option>
    </select>

    <label>H·∫°n n·ªôp b√†i:</label>
    <input type="datetime-local" id="assignDeadline">

    <button onclick="assignExam()">üì§ Giao b√†i</button>

    <div id="assignedList">
        <h2>üìÑ Danh s√°ch b√†i ƒë√£ giao</h2>
        <table>
            <thead>
                <tr>
                    <th>L·ªõp</th>
                    <th>ƒê·ªÅ</th>
                    <th>H·∫°n n·ªôp</th>
                    <th>Gi√°o vi√™n</th>
                    <th>Ng√†y giao</th>
                    <th>Xu·∫•t Word</th>
                </tr>
            </thead>
            <tbody id="assignedBody">
                <tr><td colspan="6">Ch∆∞a c√≥ b√†i n√†o ƒë∆∞·ª£c giao</td></tr>
            </tbody>
        </table>
    </div>

</div>

<script>
let exams = [];
let currentExam = null;

/* ===============================
   CH·∫∂N TRUY C·∫¨P TR√ÅI PH√âP
================================ */
if (localStorage.getItem("role") !== "teacher") {
    alert("B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p!");
    window.location.href = "index.html";
}

/* ===============================
   LOAD ƒê·ªÄ T·ª™ FILE JSON T·ª™ M√ÅY
================================ */
document.getElementById("fileExam").addEventListener("change", function(event){
    const file = event.target.files[0];
    if(!file) return;

    const reader = new FileReader();
    reader.onload = function(e){
        try{
            const json = JSON.parse(e.target.result);
            exams = [json]; // ch·ªâ load 1 ƒë·ªÅ t·∫°i 1 l·∫ßn
            currentExam = exams[0];

            document.getElementById("msg").innerHTML = `<div class="success">‚úÖ ƒê√£ t·∫£i ƒë·ªÅ: ${currentExam.title}</div>`;
        } catch(err){
            console.error(err);
            document.getElementById("msg").innerHTML = `<div class="error">‚ùå File kh√¥ng h·ª£p l·ªá!</div>`;
        }
    };
    reader.readAsText(file);
});

/* ===============================
   GIAO B√ÄI
================================ */
function assignExam(){
    const className = document.getElementById("assignClass").value;
    const deadline = document.getElementById("assignDeadline").value;
    const msg = document.getElementById("msg");
    if(!currentExam){ msg.innerHTML = `<div class="error">‚ö†Ô∏è Ch∆∞a ch·ªçn ƒë·ªÅ!</div>`; return; }
    if(!deadline){ msg.innerHTML = `<div class="error">‚ö†Ô∏è Ch∆∞a ch·ªçn h·∫°n n·ªôp!</div>`; return; }

    const teacherName = localStorage.getItem("username") || "Gi√°o vi√™n";
    const assignments = JSON.parse(localStorage.getItem("assignments") || "[]");

    assignments.push({
        examId: currentExam.id,
        examTitle: currentExam.title,
        class: className,
        teacher: teacherName,
        deadline,
        assignedAt: new Date().toLocaleString()
    });

    localStorage.setItem("assignments", JSON.stringify(assignments));
    msg.innerHTML = `<div class="success">‚úÖ ƒê√£ giao ƒë·ªÅ cho l·ªõp <b>${className}</b></div>`;
    document.getElementById("assignDeadline").value = "";
    document.getElementById("fileExam").value = "";

    loadAssigned();
}

/* ===============================
   HI·ªÇN TH·ªä DANH S√ÅCH B√ÄI ƒê√É GIAO
================================ */
function loadAssigned(){
    const tbody = document.getElementById("assignedBody");
    const assignments = JSON.parse(localStorage.getItem("assignments") || "[]");
    if(assignments.length === 0){
        tbody.innerHTML = `<tr><td colspan="6">Ch∆∞a c√≥ b√†i n√†o ƒë∆∞·ª£c giao</td></tr>`;
        return;
    }
    tbody.innerHTML = "";
    assignments.forEach(a=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${a.class}</td>
            <td>${a.examTitle}</td>
            <td>${a.deadline}</td>
            <td>${a.teacher}</td>
            <td>${a.assignedAt}</td>
            <td><button onclick='exportWord(${JSON.stringify(a)})'>üìÑ Xu·∫•t Word</button></td>
        `;
        tbody.appendChild(tr);
    });
}

/* ===============================
   XU·∫§T WORD
================================ */
async function exportWord(assignment){
    const { Document, Packer, Paragraph, TextRun } = docx;

    const doc = new Document({
        sections:[{
            properties:{},
            children:[
                new Paragraph({ children:[new TextRun({ text:"ƒê·ªÄ KI·ªÇM TRA", bold:true, size:32 })] }),
                new Paragraph({ children:[new TextRun({ text:`L·ªõp: ${assignment.class}` })] }),
                new Paragraph({ children:[new TextRun({ text:`Gi√°o vi√™n: ${assignment.teacher}` })] }),
                new Paragraph({ children:[new TextRun({ text:`H·∫°n n·ªôp: ${assignment.deadline}` })] }),
                new Paragraph({ children:[new TextRun({ text:"-------------------------" })] }),
                new Paragraph({ children:[new TextRun({ text:`N·ªôi dung ƒë·ªÅ: ${assignment.examTitle}` })] })
            ]
        }]
    });

    const blob = await Packer.toBlob(doc);
    saveAs(blob, `ƒê·ªÅ_${assignment.class}_${assignment.examId}.docx`);
}

/* ===============================
   INIT
================================ */
loadAssigned();
</script>
</body>
</html>
