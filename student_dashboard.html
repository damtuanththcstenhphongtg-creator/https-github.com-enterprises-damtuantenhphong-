<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>H·ªçc sinh | Danh s√°ch ƒë·ªÅ ki·ªÉm tra</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- PDF + Word -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.143/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.2/mammoth.browser.min.js"></script>

<style>
body { font-family:"Segoe UI",sans-serif; background:#eef3f7; padding:20px; }
h1 { text-align:center; color:#0a4a8e; }

.info {
    background:#fff;
    padding:15px;
    border-radius:8px;
    margin-bottom:20px;
    box-shadow:0 2px 8px rgba(0,0,0,0.1);
}

table { width:100%; border-collapse:collapse; }
th, td { border:1px solid #ccc; padding:8px; text-align:center; }
th { background:#3498db; color:#fff; }
tr:nth-child(even){ background:#f9f9f9; }

button {
    padding:6px 12px;
    border:none;
    border-radius:4px;
    cursor:pointer;
    background:#0b74d1;
    color:#fff;
}
button:disabled {
    background:#aaa;
    cursor:not-allowed;
}

#viewerContainer {
    margin-top:25px;
    background:#fff;
    padding:15px;
    border-radius:8px;
    box-shadow:0 2px 8px rgba(0,0,0,0.1);
    max-height:500px;
    overflow:auto;
}
</style>
</head>

<body>

<h1>üìö B√ÄI KI·ªÇM TRA ƒê∆Ø·ª¢C GIAO</h1>

<div class="info">
    <b>H·ªçc sinh:</b> <span id="studentName"></span> |
    <b>L·ªõp:</b> <span id="studentClass"></span>
    <button style="float:right;background:#e53935" onclick="logout()">ƒêƒÉng xu·∫•t</button>
</div>

<table>
<thead>
<tr>
<th>M√¥n</th>
<th>T√™n ƒë·ªÅ</th>
<th>Gi√°o vi√™n</th>
<th>Th·ªùi gian</th>
<th>H·∫°n n·ªôp</th>
<th>Tr·∫°ng th√°i</th>
<th>T·∫£i ƒë·ªÅ</th>
<th>Xem</th>
</tr>
</thead>
<tbody id="examBody">
<tr><td colspan="8">ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>
</tbody>
</table>

<div id="viewerContainer">
<h3>N·ªôi dung ƒë·ªÅ</h3>
<div id="examContent">Ch∆∞a ch·ªçn ƒë·ªÅ</div>
</div>

<script>
/* ===============================
   C·∫§U H√åNH API
================================ */
const API_BASE = "http://localhost:5000/api";

/* ===============================
   KI·ªÇM TRA ƒêƒÇNG NH·∫¨P
================================ */
if (localStorage.getItem("role") !== "student") {
    alert("B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p!");
    location.href = "index.html";
}

const username = localStorage.getItem("username");
const studentClass = localStorage.getItem("class");

if (!username || !studentClass) {
    alert("Phi√™n ƒëƒÉng nh·∫≠p kh√¥ng h·ª£p l·ªá!");
    localStorage.clear();
    location.href = "index.html";
}

document.getElementById("studentName").textContent = username;
document.getElementById("studentClass").textContent = studentClass;

/* ===============================
   LOAD B√ÄI KI·ªÇM TRA
================================ */
async function loadExams() {
    const tbody = document.getElementById("examBody");

    try {
        const res = await fetch(
            `${API_BASE}/student_exams?class=${encodeURIComponent(studentClass)}`
        );

        const exams = await res.json();

        if (!exams.length) {
            tbody.innerHTML =
                `<tr><td colspan="8">‚ùå Ch∆∞a c√≥ b√†i n√†o ƒë∆∞·ª£c giao</td></tr>`;
            return;
        }

        tbody.innerHTML = "";

        const now = new Date();

        exams.forEach(exam => {
            const deadline = new Date(exam.deadline);
            const expired = deadline < now;

            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td>${exam.subject}</td>
                <td>${exam.title}</td>
                <td>${exam.teacher}</td>
                <td>${exam.duration} ph√∫t</td>
                <td>${deadline.toLocaleString()}</td>
                <td>${expired ? "‚õî H·∫øt h·∫°n" : "üü¢ C√≤n h·∫°n"}</td>
                <td>
                    <a href="${exam.file}" download>
                        <button ${expired ? "disabled" : ""}>üìÑ T·∫£i</button>
                    </a>
                </td>
                <td>
                    <button ${expired ? "disabled" : ""}
                        onclick="viewExam('${exam.file}')">
                        üëÅÔ∏è Xem
                    </button>
                </td>
            `;
            tbody.appendChild(tr);
        });

    } catch (e) {
        tbody.innerHTML =
            `<tr><td colspan="8">‚ùå Kh√¥ng k·∫øt n·ªëi ƒë∆∞·ª£c m√°y ch·ªß</td></tr>`;
    }
}

/* ===============================
   XEM ƒê·ªÄ
================================ */
async function viewExam(filePath) {
    const contentDiv = document.getElementById("examContent");
    contentDiv.innerHTML = "";

    const ext = filePath.split(".").pop().toLowerCase();

    if (ext === "pdf") {
        const pdf = await pdfjsLib.getDocument(filePath).promise;
        for (let i = 1; i <= pdf.numPages; i++) {
            const page = await pdf.getPage(i);
            const viewport = page.getViewport({ scale: 1.2 });
            const canvas = document.createElement("canvas");
            const ctx = canvas.getContext("2d");
            canvas.width = viewport.width;
            canvas.height = viewport.height;
            await page.render({ canvasContext: ctx, viewport }).promise;
            contentDiv.appendChild(canvas);
        }
    }
    else if (ext === "docx") {
        const res = await fetch(filePath);
        const buffer = await res.arrayBuffer();
        const result = await mammoth.extractRawText({ arrayBuffer: buffer });
        contentDiv.innerHTML = `<pre>${result.value}</pre>`;
    }
    else {
        contentDiv.textContent = "‚ùå Kh√¥ng h·ªó tr·ª£ ƒë·ªãnh d·∫°ng n√†y";
    }
}

/* ===============================
   ƒêƒÇNG XU·∫§T
================================ */
function logout() {
    localStorage.clear();
    location.href = "index.html";
}

/* ===============================
   INIT
================================ */
document.addEventListener("DOMContentLoaded", loadExams);
</script>

</body>
</html>
