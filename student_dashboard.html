<script>
/* ===============================
   KI·ªÇM TRA QUY·ªÄN
================================ */
if (localStorage.getItem("role") !== "student") {
    alert("B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p!");
    window.location.href = "index.html";
}

/* ===============================
   TH√îNG TIN H·ªåC SINH (L·∫§Y KHI ƒêƒÇNG NH·∫¨P)
================================ */
const studentClass = localStorage.getItem("class"); // v√≠ d·ª•: 7A1
if (!studentClass) {
    alert("Kh√¥ng x√°c ƒë·ªãnh ƒë∆∞·ª£c l·ªõp h·ªçc sinh!");
}

/* ===============================
   LOAD B√ÄI T·ª™ SERVER
================================ */
async function loadExams() {
    const tbody = document.getElementById("examBody");

    try {
        const res = await fetch(
            `http://localhost:5000/student_exams?class=${studentClass}`
        );

        if (!res.ok) throw new Error("HTTP " + res.status);

        const assignments = await res.json();

        if (assignments.length === 0) {
            tbody.innerHTML =
                `<tr><td colspan="6">‚ùå Ch∆∞a c√≥ b√†i n√†o ƒë∆∞·ª£c giao</td></tr>`;
            return;
        }

        tbody.innerHTML = "";

        assignments.forEach(a => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td>${a.class}</td>
                <td>${a.title}</td>
                <td>${a.deadline}</td>
                <td>${a.subject}</td>
                <td>
                    <a href="${a.file}" download>
                        <button>üìÑ T·∫£i</button>
                    </a>
                </td>
                <td>
                    <button onclick="viewExam('${a.file}')">
                        üëÅÔ∏è Xem
                    </button>
                </td>
            `;
            tbody.appendChild(tr);
        });

    } catch (err) {
        console.error(err);
        document.getElementById("errorMsg").style.display = "block";
        document.getElementById("errorMsg").textContent =
            "‚ùå Kh√¥ng k·∫øt n·ªëi ƒë∆∞·ª£c server!";
        tbody.innerHTML =
            `<tr><td colspan="6">‚ùå L·ªói t·∫£i d·ªØ li·ªáu</td></tr>`;
    }
}

/* ===============================
   XEM FILE ƒê·ªÄ
================================ */
async function viewExam(filePath) {
    const contentDiv = document.getElementById("examContent");
    contentDiv.innerHTML = "";

    const ext = filePath.split('.').pop().toLowerCase();

    if (ext === "pdf") {
        const pdf = await pdfjsLib.getDocument(filePath).promise;
        for (let i = 1; i <= pdf.numPages; i++) {
            const page = await pdf.getPage(i);
            const viewport = page.getViewport({ scale: 1.2 });
            const canvas = document.createElement("canvas");
            const ctx = canvas.getContext("2d");
            canvas.height = viewport.height;
            canvas.width = viewport.width;
            await page.render({ canvasContext: ctx, viewport }).promise;
            contentDiv.appendChild(canvas);
        }
    } else if (ext === "docx") {
        const res = await fetch(filePath);
        const buffer = await res.arrayBuffer();
        const result = await mammoth.extractRawText({ arrayBuffer: buffer });
        contentDiv.innerHTML = `<pre>${result.value}</pre>`;
    } else {
        contentDiv.innerHTML = "‚ùå Kh√¥ng h·ªó tr·ª£ ƒë·ªãnh d·∫°ng n√†y";
    }
}

/* ===============================
   INIT
================================ */
loadExams();
</script>
