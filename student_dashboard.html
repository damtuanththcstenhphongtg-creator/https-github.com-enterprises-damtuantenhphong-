<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Trang h·ªçc sinh ‚Äì Danh s√°ch ƒë·ªÅ ki·ªÉm tra</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Th∆∞ vi·ªán ƒë·ªçc Word -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.2/mammoth.browser.min.js"></script>
<!-- Th∆∞ vi·ªán ƒë·ªçc PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.143/pdf.min.js"></script>

<style>
body { font-family:"Segoe UI",sans-serif; background:#eef3f7; margin:0; padding:20px; }
h1 { text-align:center; color:#0a4a8e; }
table { width:100%; border-collapse: collapse; margin-top:20px; }
th, td { border:1px solid #ccc; padding:8px; text-align:center; }
th { background:#3498db; color:#fff; }
tr:nth-child(even){background:#f9f9f9;}
button { padding:6px 12px; border:none; border-radius:4px; cursor:pointer; background:#0b74d1; color:#fff;}
button:hover { background:#095ba8; }
#viewerContainer { margin-top:30px; padding:15px; background:#fff; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,0.1); max-height:500px; overflow:auto; }
#viewerContainer h2 { margin-top:0; color:#0a4a8e; }
#errorMsg { background:#ffe2e2; padding:12px; border-left:5px solid #e53935; border-radius:8px; margin-top:15px; display:none; }
</style>
</head>
<body>

<h1>üìö Danh s√°ch ƒë·ªÅ ki·ªÉm tra</h1>

<div id="errorMsg"></div>

<table>
<thead>
<tr>
<th>L·ªõp</th>
<th>ƒê·ªÅ</th>
<th>H·∫°n n·ªôp</th>
<th>Gi√°o vi√™n</th>
<th>T·∫£i v·ªÅ</th>
<th>Xem n·ªôi dung</th>
</tr>
</thead>
<tbody id="examBody">
<tr><td colspan="6">ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>
</tbody>
</table>

<div id="viewerContainer">
<h2>N·ªôi dung ƒë·ªÅ ki·ªÉm tra</h2>
<div id="examContent">Ch∆∞a c√≥ ƒë·ªÅ ƒë∆∞·ª£c ch·ªçn.</div>
</div>

<script>
/* ===============================
   CH·∫∂N TRUY C·∫¨P TR√ÅI PH√âP
================================ */
if(localStorage.getItem("role")!=="student"){
    alert("B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p!");
    window.location.href="index.html";
}

/* ===============================
   LOAD DANH S√ÅCH B√ÄI ƒê√É GIAO T·ª™ SERVER
================================ */
let assignments = [];

async function loadExams(){
    const tbody = document.getElementById("examBody");
    try {
        const res = await fetch("/assignments");
        if(!res.ok) throw new Error("HTTP " + res.status);
        assignments = await res.json();
        if(assignments.length===0){
            tbody.innerHTML = `<tr><td colspan="6">‚ùå Ch∆∞a c√≥ b√†i n√†o ƒë∆∞·ª£c giao!</td></tr>`;
            return;
        }

        tbody.innerHTML = "";
        assignments.forEach(a=>{
            const tr=document.createElement("tr");
            tr.innerHTML=`
                <td>${a.class}</td>
                <td>${a.examTitle}</td>
                <td>${a.deadline}</td>
                <td>${a.teacher}</td>
                <td><a href="/uploads/${a.file}" download><button>üìÑ T·∫£i</button></a></td>
                <td><button onclick='viewExam("/uploads/${a.file}")'>üëÅÔ∏è Xem</button></td>
            `;
            tbody.appendChild(tr);
        });

    } catch(err){
        console.error(err);
        const msg = document.getElementById("errorMsg");
        msg.style.display = "block";
        msg.textContent = "‚ùå Kh√¥ng th·ªÉ t·∫£i danh s√°ch ƒë·ªÅ ki·ªÉm tra!";
        tbody.innerHTML = `<tr><td colspan="6">‚ùå L·ªói t·∫£i d·ªØ li·ªáu</td></tr>`;
    }
}

/* ===============================
   XEM N·ªòI DUNG ƒê·ªÄ (PDF ho·∫∑c Word)
================================ */
async function viewExam(filePath){
    const contentDiv = document.getElementById("examContent");
    contentDiv.innerHTML = "";

    const ext = filePath.split('.').pop().toLowerCase();

    if(ext==='pdf'){
        // PDF.js
        const loadingTask = pdfjsLib.getDocument(filePath);
        const pdf = await loadingTask.promise;
        contentDiv.innerHTML = '';
        for(let i=1; i<=pdf.numPages; i++){
            const page = await pdf.getPage(i);
            const viewport = page.getViewport({scale:1.2});
            const canvas = document.createElement("canvas");
            const ctx = canvas.getContext('2d');
            canvas.height = viewport.height;
            canvas.width = viewport.width;
            await page.render({canvasContext: ctx, viewport: viewport}).promise;
            contentDiv.appendChild(canvas);
        }
    } else if(ext==='docx'){
        // Word
        try {
            const response = await fetch(filePath);
            const arrayBuffer = await response.arrayBuffer();
            const result = await mammoth.extractRawText({arrayBuffer});
            contentDiv.innerHTML = `<pre>${result.value}</pre>`;
        } catch(e){
            contentDiv.innerHTML = `<div style="color:red;">‚ùå Kh√¥ng th·ªÉ ƒë·ªçc file Word</div>`;
        }
    } else {
        contentDiv.innerHTML = `<div style="color:red;">‚ùå Lo·∫°i file kh√¥ng ƒë∆∞·ª£c h·ªó tr·ª£</div>`;
    }
}

/* ===============================
   INIT
================================ */
loadExams();
</script>

</body>
</html>
