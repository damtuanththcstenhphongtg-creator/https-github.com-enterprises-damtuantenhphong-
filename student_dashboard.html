<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>H·ªçc sinh | Danh s√°ch b√†i ki·ªÉm tra</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- PDF & Word -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.143/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.2/mammoth.browser.min.js"></script>

<style>
body{
    font-family:"Segoe UI",sans-serif;
    background:#eef3f7;
    margin:0;
    padding:20px;
}
h1{
    text-align:center;
    color:#0a4a8e;
}
.info{
    text-align:center;
    margin-bottom:15px;
    font-weight:bold;
}
table{
    width:100%;
    border-collapse:collapse;
    background:#fff;
}
th,td{
    border:1px solid #ccc;
    padding:8px;
    text-align:center;
}
th{
    background:#3498db;
    color:#fff;
}
tr:nth-child(even){
    background:#f9f9f9;
}
button{
    padding:6px 12px;
    border:none;
    border-radius:5px;
    background:#0b74d1;
    color:#fff;
    cursor:pointer;
}
button:hover{
    background:#095ba8;
}
#errorMsg{
    display:none;
    background:#ffe2e2;
    border-left:5px solid #e53935;
    padding:12px;
    margin:15px 0;
    border-radius:6px;
}
#viewer{
    margin-top:25px;
    background:#fff;
    padding:15px;
    border-radius:8px;
    max-height:550px;
    overflow:auto;
}
.logout{
    float:right;
    background:#e53935;
}
.logout:hover{
    background:#c62828;
}
</style>
</head>

<body>

<h1>üìö B√ÄI KI·ªÇM TRA C·ª¶A H·ªåC SINH</h1>

<div class="info" id="studentInfo"></div>

<button class="logout" onclick="logout()">ƒêƒÉng xu·∫•t</button>

<div id="errorMsg"></div>

<table>
<thead>
<tr>
    <th>L·ªõp</th>
    <th>ƒê·ªÅ</th>
    <th>Gi√°o vi√™n</th>
    <th>H·∫°n n·ªôp</th>
    <th>T·∫£i</th>
    <th>Xem</th>
</tr>
</thead>
<tbody id="examBody">
<tr><td colspan="6">ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>
</tbody>
</table>

<div id="viewer">
    <h3>N·ªôi dung ƒë·ªÅ</h3>
    <div id="examContent">Ch∆∞a ch·ªçn ƒë·ªÅ.</div>
</div>

<script>
/* ===============================
   KI·ªÇM TRA PHI√äN ƒêƒÇNG NH·∫¨P
================================ */
const role = localStorage.getItem("role");
const username = localStorage.getItem("username");
const studentClass = localStorage.getItem("class");

if (!role || !username || !studentClass || role !== "student") {
    alert("Phi√™n ƒëƒÉng nh·∫≠p kh√¥ng h·ª£p l·ªá ho·∫∑c ƒë√£ h·∫øt h·∫°n!");
    localStorage.clear();
    location.href = "index.html";
}

/* ===============================
   HI·ªÇN TH·ªä TH√îNG TIN HS
================================ */
document.getElementById("studentInfo").textContent =
    `üë§ H·ªçc sinh: ${username} | üè´ L·ªõp: ${studentClass}`;

/* ===============================
   LOAD B√ÄI KI·ªÇM TRA THEO L·ªöP
================================ */
async function loadExams(){
    const tbody = document.getElementById("examBody");
    try{
        const res = await fetch(`/student_exams?class=${studentClass}`);
        if(!res.ok) throw new Error("HTTP " + res.status);

        const exams = await res.json();

        if(exams.length === 0){
            tbody.innerHTML =
              `<tr><td colspan="6">‚ùå Ch∆∞a c√≥ b√†i ƒë∆∞·ª£c giao</td></tr>`;
            return;
        }

        tbody.innerHTML = "";
        exams.forEach(e=>{
            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td>${e.class}</td>
                <td>${e.title || "ƒê·ªÅ ki·ªÉm tra"}</td>
                <td>${e.teacher}</td>
                <td>${new Date(e.deadline).toLocaleString()}</td>
                <td>
                    <a href="${e.file}" download>
                        <button>üìÑ T·∫£i</button>
                    </a>
                </td>
                <td>
                    <button onclick="viewExam('${e.file}')">üëÅÔ∏è Xem</button>
                </td>
            `;
            tbody.appendChild(tr);
        });

    }catch(err){
        console.error(err);
        const msg = document.getElementById("errorMsg");
        msg.style.display = "block";
        msg.textContent = "‚ùå Kh√¥ng k·∫øt n·ªëi ƒë∆∞·ª£c m√°y ch·ªß!";
        tbody.innerHTML =
          `<tr><td colspan="6">‚ùå L·ªói t·∫£i d·ªØ li·ªáu</td></tr>`;
    }
}

/* ===============================
   XEM FILE ƒê·ªÄ
================================ */
async function viewExam(file){
    const content = document.getElementById("examContent");
    content.innerHTML = "";

    const ext = file.split(".").pop().toLowerCase();

    if(ext === "pdf"){
        const pdf = await pdfjsLib.getDocument(file).promise;
        for(let i=1;i<=pdf.numPages;i++){
            const page = await pdf.getPage(i);
            const viewport = page.getViewport({scale:1.2});
            const canvas = document.createElement("canvas");
            canvas.height = viewport.height;
            canvas.width = viewport.width;
            await page.render({
                canvasContext: canvas.getContext("2d"),
                viewport
            }).promise;
            content.appendChild(canvas);
        }
    }
    else if(ext === "docx"){
        const res = await fetch(file);
        const buffer = await res.arrayBuffer();
        const result = await mammoth.extractRawText({arrayBuffer:buffer});
        content.innerHTML = `<pre>${result.value}</pre>`;
    }
    else{
        content.textContent = "‚ùå Kh√¥ng h·ªó tr·ª£ ƒë·ªãnh d·∫°ng n√†y";
    }
}

/* ===============================
   ƒêƒÇNG XU·∫§T
================================ */
function logout(){
    localStorage.clear();
    location.href = "index.html";
}

/* ===============================
   INIT
================================ */
loadExams();
</script>

</body>
</html>
