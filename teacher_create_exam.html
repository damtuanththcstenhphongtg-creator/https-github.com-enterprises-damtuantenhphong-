<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8">
<title>üìò Teacher Create Exam</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
<style>
body{font-family:'Roboto',sans-serif;background:#f4f6f9;margin:0;padding:20px;}
h1{text-align:center;color:#2c3e50;}
.card{background:#fff;border-radius:8px;padding:20px;margin:15px auto;max-width:1000px;box-shadow:0 4px 8px rgba(0,0,0,0.1);}
label{display:block;margin:10px 0 5px;font-weight:bold;}
input, select{width:100%;padding:8px;border:1px solid #ccc;border-radius:6px;}
input[type=number]{width:60px;}
.btn-group{text-align:center;margin-top:20px;}
button{background:#3498db;color:white;border:none;padding:10px 18px;margin:5px;border-radius:6px;cursor:pointer;transition:0.3s;}
button:hover{background:#2980b9;}
.lesson-card{background:#ecf0f1;padding:10px;border-radius:6px;margin-bottom:15px;}
.lesson-card h3{margin-top:0;}
.question{margin:5px 0;padding:5px;border-left:4px solid #3498db;background:#fefefe;position:relative;}
.question.truefalse{border-left-color:#27ae60;background:#f0fff0;}
.question.short{border-left-color:#8e44ad;background:#f8f0ff;}
.question.essay{border-left-color:#e67e22;background:#fff8f0;}
.remove-btn{background:#e74c3c;color:white;border:none;padding:2px 5px;margin-left:5px;border-radius:4px;cursor:pointer;position:absolute;right:5px;top:5px;}
.remove-btn:hover{background:#c0392b;}
#container{margin-top:20px;padding:15px;background:#ecf0f1;border-radius:8px;border:1px solid #bdc3c7;}
.section-title{font-size:18px;font-weight:bold;margin-bottom:10px;color:#2c3e50;}
.code-label{font-weight:bold;color:#c0392b;margin-bottom:10px;font-size:16px;}
</style>
</head>
<body>

<h1>üìò Teacher Create Exam</h1>

<div class="card">
<label>M√¥n h·ªçc:</label>
<select id="subjectSelect">
<option>To√°n</option>
<option>Ng·ªØ vƒÉn</option>
<option>Ti·∫øng Anh</option>
<option>L·ªãch s·ª≠</option>
<option>Tin h·ªçc</option>
<option>C√¥ng ngh·ªá</option>
</select>

<label>L·ªõp:</label>
<select id="gradeSelect">
<option>1</option><option>2</option><option>3</option><option>4</option>
<option>5</option><option>6</option><option>7</option><option>8</option><option>9</option>
</select>

<label>T√™n file JSON (trong /questions/, v√≠ d·ª•: tin6_bai8.json):</label>
<input type="text" id="jsonFileInput" placeholder="v√≠ d·ª•: tin6_bai8.json">

<button id="loadFileBtn">üì• Load c√¢u h·ªèi t·ª´ file</button>

<div id="lessonSelectContainer" style="display:none;">
<label>Ch·ªçn b√†i mu·ªën t·∫°o:</label>
<select id="lessonSelect" multiple style="height:100px"></select>

<p>Ch·ªçn s·ªë c√¢u m·ªói lo·∫°i c√¢u h·ªèi m·ªói b√†i:</p>
<label>MCQ m·ªói b√†i:</label> <input type="number" id="numMCQ" value="2">
<label>True/False m·ªói b√†i:</label> <input type="number" id="numTF" value="1">
<label>Short Answer m·ªói b√†i:</label> <input type="number" id="numShort" value="1">
<label>Essay m·ªói b√†i:</label> <input type="number" id="numEssay" value="1">

<label>S·ªë ƒë·ªÅ c·∫ßn t·∫°o:</label>
<input type="number" id="numExamsInput" value="1" min="1">

<div class="btn-group">
<button id="generateBtn">üöÄ T·∫°o ƒë·ªÅ</button>
<button id="previewBtn">üëÄ Xem tr∆∞·ªõc</button>
<button id="exportWordBtn">üìÑ Xu·∫•t Word t·ª´ng ƒë·ªÅ</button>
<button id="exportJsonBtn">üíæ Xu·∫•t JSON t·ª´ng ƒë·ªÅ</button>
</div>
</div>
</div>

<div id="container"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/docx/8.3.2/docx.min.js"></script>

<script>
const subjectSelect = document.getElementById("subjectSelect");
const gradeSelect = document.getElementById("gradeSelect");
const jsonFileInput = document.getElementById("jsonFileInput");
const loadFileBtn = document.getElementById("loadFileBtn");
const lessonSelectContainer = document.getElementById("lessonSelectContainer");
const lessonSelect = document.getElementById("lessonSelect");
const numMCQ = document.getElementById("numMCQ");
const numTF = document.getElementById("numTF");
const numShort = document.getElementById("numShort");
const numEssay = document.getElementById("numEssay");
const numExamsInput = document.getElementById("numExamsInput");
const container = document.getElementById("container");

let allQuestions = [];
let generatedExams = [];

// Sinh m√£ ƒë·ªÅ
function generateExamCode(){return "DE-"+Math.floor(1000+Math.random()*9000);}

// Load JSON t·ª´ file
loadFileBtn.onclick = async()=>{
  const fileName = jsonFileInput.value.trim();
  if(!fileName){ alert("Nh·∫≠p t√™n file JSON!"); return; }
  try{
    const res = await fetch("questions/"+fileName);
    const data = await res.json();
    allQuestions = [];
    lessonSelect.innerHTML = "";
    data.lessons.forEach(lesson=>{
      const option = document.createElement("option");
      option.value = lesson.lesson;
      option.textContent = lesson.lesson;
      lessonSelect.appendChild(option);
      lesson.questions.forEach(q=>{
        allQuestions.push({...q, lesson: lesson.lesson});
      });
    });
    lessonSelectContainer.style.display="block";
    alert(`ƒê√£ load ${allQuestions.length} c√¢u h·ªèi t·ª´ ${fileName}`);
  }catch(err){
    alert("Kh√¥ng t√¨m th·∫•y file ho·∫∑c l·ªói JSON!");
    console.error(err);
    allQuestions=[];
    lessonSelectContainer.style.display="none";
  }
};

// T·∫°o ƒë·ªÅ
document.getElementById("generateBtn").onclick = ()=>{
  const selectedLessons = Array.from(lessonSelect.selectedOptions).map(o=>o.value);
  const numExams = parseInt(numExamsInput.value);
  if(selectedLessons.length===0){ alert("Ch·ªçn √≠t nh·∫•t 1 b√†i!"); return; }

  generatedExams=[];
  for(let e=0;e<numExams;e++){
    const examCode = generateExamCode();
    const exam = {examCode, subject: subjectSelect.value, grade: gradeSelect.value, questions: []};

    selectedLessons.forEach(lesson=>{
      const lessonQs = allQuestions.filter(q=>q.lesson===lesson);
      const mcq = lessonQs.filter(q=>q.type==="mcq").slice(0,parseInt(numMCQ.value));
      const tf = lessonQs.filter(q=>q.type==="truefalse").slice(0,parseInt(numTF.value));
      const short = lessonQs.filter(q=>q.type==="short").slice(0,parseInt(numShort.value));
      const essay = lessonQs.filter(q=>q.type==="essay").slice(0,parseInt(numEssay.value));
      exam.questions.push(...mcq,...tf,...short,...essay);
    });

    // Tr·ªôn c√¢u
    exam.questions.sort(()=>Math.random()-0.5);
    generatedExams.push(exam);
  }
  alert(`ƒê√£ t·∫°o ${numExams} ƒë·ªÅ th√†nh c√¥ng!`);
};

// Xem tr∆∞·ªõc + x√≥a c√¢u
document.getElementById("previewBtn").onclick = ()=>{
  if(generatedExams.length===0){ alert("Ch∆∞a t·∫°o ƒë·ªÅ!"); return; }
  container.innerHTML="";
  generatedExams.forEach(exam=>{
    const codeDiv = document.createElement("div");
    codeDiv.className = "code-label";
    codeDiv.textContent = `M√£ ƒë·ªÅ: ${exam.examCode}`;
    container.appendChild(codeDiv);

    const div = document.createElement("div");
    div.innerHTML = `<div class="section-title">${exam.subject} ${exam.grade}</div>`;

    exam.questions.forEach(q=>{
      const qd = document.createElement("div");
      qd.className = "question "+q.type;
      if(q.type==="mcq") qd.innerHTML=`<b>${q.content}</b><br>A. ${q.options.A}<br>B. ${q.options.B}<br>C. ${q.options.C}<br>D. ${q.options.D}`;
      else if(q.type==="truefalse") qd.innerHTML=`<b>${q.content}</b> (ƒê√∫ng/Sai)`;
      else if(q.type==="short") qd.innerHTML=`<b>${q.content}</b> (Tr·∫£ l·ªùi ng·∫Øn)`;
      else qd.innerHTML=`<b>${q.content}</b><br><i>(H·ªçc sinh t·ª± l√†m)</i>`;

      const removeBtn = document.createElement("button");
      removeBtn.className="remove-btn";
      removeBtn.textContent="X√≥a";
      removeBtn.onclick = (()=>{
        const ques=q;
        return ()=>{
          exam.questions = exam.questions.filter(x=>x!==ques);
          qd.remove();
        };
      })();
      qd.appendChild(removeBtn);

      div.appendChild(qd);
    });
    container.appendChild(div);
  });
};

// Xu·∫•t Word
document.getElementById("exportWordBtn").onclick=async()=>{
  if(generatedExams.length===0){ alert("Ch∆∞a t·∫°o ƒë·ªÅ!"); return; }
  const {Document,Packer,Paragraph,TextRun}=docx;
  for(const exam of generatedExams){
    const doc = new Document({
      sections:[{
        children:[
          new Paragraph({children:[new TextRun({text:`M√É ƒê·ªÄ: ${exam.examCode}`,bold:true,color:"red",size:48})]}),
          new Paragraph({children:[new TextRun({text:`${exam.subject} ${exam.grade}`,bold:true,size:56})]}),
          ...exam.questions.flatMap(q=>{
            let arr=[new Paragraph(q.content)];
            if(q.type==="mcq" && q.options){
              Object.keys(q.options).forEach(k=>arr.push(new Paragraph(`${k}. ${q.options[k]}`)));
            }
            return arr;
          })
        ]
      }]
    });
    const blob=await Packer.toBlob(doc);
    saveAs(blob,`De_${exam.examCode}.docx`);
  }
};

// Xu·∫•t JSON
document.getElementById("exportJsonBtn").onclick=()=>{
  if(generatedExams.length===0){ alert("Ch∆∞a t·∫°o ƒë·ªÅ!"); return; }
  for(const exam of generatedExams){
    saveAs(new Blob([JSON.stringify(exam,null,2)],{type:"application/json"}),`De_${exam.examCode}.json`);
  }
};
</script>
</body>
</html>