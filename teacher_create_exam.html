<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8">
<title>üìò H·ªá th·ªëng t·∫°o ƒë·ªÅ ki·ªÉm tra n√¢ng cao</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
<style>
body{font-family:'Roboto',sans-serif;background:#f4f6f9;margin:0;padding:20px;}
h1{text-align:center;color:#2c3e50;}
.card{background:#fff;border-radius:8px;padding:20px;margin:15px auto;max-width:1000px;box-shadow:0 4px 8px rgba(0,0,0,0.1);}
label{display:block;margin:10px 0 5px;font-weight:bold;}
input, select{width:100%;padding:8px;border:1px solid #ccc;border-radius:6px;}
input[type=number]{width:60px;}
.btn-group{text-align:center;margin-top:20px;}
button{background:#3498db;color:white;border:none;padding:10px 18px;margin:5px;border-radius:6px;cursor:pointer;transition:0.3s;}
button:hover{background:#2980b9;}
.lesson-card{background:#ecf0f1;padding:10px;border-radius:6px;margin-bottom:15px;}
.lesson-card h3{margin-top:0;}
.question{margin:5px 0;padding:5px;border-left:4px solid #3498db;background:#fefefe;position:relative;}
.question.truefalse{border-left-color:#27ae60;background:#f0fff0;}
.question.short{border-left-color:#8e44ad;background:#f8f0ff;}
.question.essay{border-left-color:#e67e22;background:#fff8f0;}
.remove-btn{background:#e74c3c;color:white;border:none;padding:2px 5px;margin-left:5px;border-radius:4px;cursor:pointer;position:absolute;right:5px;top:5px;}
.remove-btn:hover{background:#c0392b;}
#container{margin-top:20px;padding:15px;background:#ecf0f1;border-radius:8px;border:1px solid #bdc3c7;}
.section-title{font-size:18px;font-weight:bold;margin-bottom:10px;color:#2c3e50;}
.code-label{font-weight:bold;color:#c0392b;margin-bottom:10px;font-size:16px;}
</style>
</head>
<body>

<h1>üìò H·ªá th·ªëng t·∫°o ƒë·ªÅ ki·ªÉm tra n√¢ng cao</h1>

<div class="card">
<label>M√¥n h·ªçc:</label>
<select id="subjectSelect">
<option>To√°n</option>
<option>Ng·ªØ vƒÉn</option>
<option>Ti·∫øng Anh</option>
<option>L·ªãch s·ª≠</option>
</select>

<label>L·ªõp:</label>
<select id="gradeSelect">
<option>1</option><option>2</option><option>3</option><option>4</option>
<option>5</option><option>6</option><option>7</option><option>8</option><option>9</option>
</select>

<label>B√†i mu·ªën t·∫°o (v√≠ d·ª•: 1,3,5):</label>
<input type="text" id="lessonInput" placeholder="1,3,5">

<label>S·ªë ƒë·ªÅ c·∫ßn t·∫°o:</label>
<input type="number" id="numExamsInput" value="1" min="1">

<div id="questionNumbersContainer">
<p>Ch·ªçn s·ªë c√¢u cho m·ªói lo·∫°i c√¢u h·ªèi m·ªói b√†i:</p>
<label>MCQ m·ªói b√†i:</label> <input type="number" id="numMCQ" value="2">
<label>True/False m·ªói b√†i:</label> <input type="number" id="numTF" value="1">
<label>Short Answer m·ªói b√†i:</label> <input type="number" id="numShort" value="1">
<label>Essay m·ªói b√†i:</label> <input type="number" id="numEssay" value="1">
</div>

<div class="btn-group">
<button id="generateBtn">üöÄ T·∫°o ƒë·ªÅ</button>
<button id="previewBtn">üëÄ Xem tr∆∞·ªõc</button>
<button id="exportWordBtn">üìÑ Xu·∫•t Word t·ª´ng ƒë·ªÅ</button>
<button id="exportJsonBtn">üíæ Xu·∫•t JSON t·ª´ng ƒë·ªÅ</button>
</div>
</div>

<div id="container"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/docx/8.3.2/docx.min.js"></script>
<script>
const subjectSelect=document.getElementById("subjectSelect");
const gradeSelect=document.getElementById("gradeSelect");
const lessonInput=document.getElementById("lessonInput");
const numExamsInput=document.getElementById("numExamsInput");
const numMCQ=document.getElementById("numMCQ");
const numTF=document.getElementById("numTF");
const numShort=document.getElementById("numShort");
const numEssay=document.getElementById("numEssay");
const container=document.getElementById("container");

let generatedExams=[];

// Sinh m√£ ƒë·ªÅ DE-XXXX
function generateExamCode(){return "DE-"+Math.floor(1000+Math.random()*9000);}

// ================== T·∫†O ƒê·ªÄ ==================
document.getElementById("generateBtn").onclick = ()=>{
  const lessons=lessonInput.value.split(",").map(n=>n.trim()).filter(n=>n!=="");
  const numExams=parseInt(numExamsInput.value);
  if(lessons.length===0){ alert("Nh·∫≠p √≠t nh·∫•t 1 b√†i!"); return; }

  generatedExams=[];
  for(let e=0;e<numExams;e++){
    const examCode=generateExamCode();
    const exam={examCode,subject:subjectSelect.value,grade:gradeSelect.value,questions:[]};

    lessons.forEach(lesson=>{
      for(let i=1;i<=parseInt(numMCQ.value);i++)
        exam.questions.push({lesson,type:"mcq",content:`(${lesson}) C√¢u ${i}: N·ªôi dung MCQ`,options:{A:"A",B:"B",C:"C",D:"D"}});
      for(let i=1;i<=parseInt(numTF.value);i++)
        exam.questions.push({lesson,type:"truefalse",content:`(${lesson}) C√¢u ${i}: N·ªôi dung ƒê√∫ng/Sai`});
      for(let i=1;i<=parseInt(numShort.value);i++)
        exam.questions.push({lesson,type:"short",content:`(${lesson}) C√¢u ${i}: N·ªôi dung tr·∫£ l·ªùi ng·∫Øn`});
      for(let i=1;i<=parseInt(numEssay.value);i++)
        exam.questions.push({lesson,type:"essay",content:`(${lesson}) C√¢u ${i}: N·ªôi dung t·ª± lu·∫≠n`});
    });

    // Tr·ªôn ng·∫´u nhi√™n c√¢u h·ªèi
    exam.questions.sort(()=>Math.random()-0.5);
    generatedExams.push(exam);
  }

  alert(`ƒê√£ t·∫°o ${numExams} ƒë·ªÅ th√†nh c√¥ng!`);
};

// ================== XEM TR∆Ø·ªöC + X√ìA C√ÇU ==================
document.getElementById("previewBtn").onclick = ()=>{
  container.innerHTML="";
  generatedExams.forEach(exam=>{
    const codeDiv=document.createElement("div");
    codeDiv.className="code-label";
    codeDiv.textContent=`M√£ ƒë·ªÅ: ${exam.examCode}`;
    container.appendChild(codeDiv);

    const div=document.createElement("div");
    div.innerHTML=`<div class="section-title">${exam.subject} ${exam.grade}</div>`;
    exam.questions.forEach((q,index)=>{
      const qd=document.createElement("div");
      qd.className="question "+q.type;
      if(q.type==="mcq") qd.innerHTML=`<b>${q.content}</b><br>A. ${q.options.A}<br>B. ${q.options.B}<br>C. ${q.options.C}<br>D. ${q.options.D}`;
      else if(q.type==="truefalse") qd.innerHTML=`<b>${q.content}</b> (ƒê√∫ng/Sai)`;
      else if(q.type==="short") qd.innerHTML=`<b>${q.content}</b> (Tr·∫£ l·ªùi ng·∫Øn)`;
      else qd.innerHTML=`<b>${q.content}</b><br><i>(H·ªçc sinh t·ª± l√†m)</i>`;

      // N√∫t x√≥a c√¢u
      const removeBtn=document.createElement("button");
      removeBtn.className="remove-btn";
      removeBtn.textContent="X√≥a";
      removeBtn.onclick=()=>{ exam.questions.splice(index,1); qd.remove(); };
      qd.appendChild(removeBtn);

      div.appendChild(qd);
    });
    container.appendChild(div);
  });
};

// ================== XU·∫§T WORD T·ª™NG ƒê·ªÄ ==================
document.getElementById("exportWordBtn").onclick=async()=>{
  const {Document,Packer,Paragraph,TextRun}=docx;
  for(const exam of generatedExams){
    const doc=new Document({
      sections:[{
        children:[
          new Paragraph({children:[new TextRun({text:`M√É ƒê·ªÄ: ${exam.examCode}`,bold:true,color:"red",size:24})]}),
          new Paragraph({children:[new TextRun({text:`${exam.subject} ${exam.grade}`,bold:true,size:28})]}),
          ...exam.questions.flatMap(q=>{
            let arr=[new Paragraph(q.content)];
            if(q.type==="mcq") Object.keys(q.options).forEach(k=>arr.push(new Paragraph(`${k}. ${q.options[k]}`)));
            return arr;
          })
        ]
      }]
    });
    const blob=await Packer.toBlob(doc);
    saveAs(blob,`De_${exam.examCode}.docx`);
  }
};

// ================== XU·∫§T JSON T·ª™NG ƒê·ªÄ ==================
document.getElementById("exportJsonBtn").onclick=()=>{
  for(const exam of generatedExams){
    saveAs(new Blob([JSON.stringify(exam,null,2)],{type:"application/json"}),`De_${exam.examCode}.json`);
  }
};
</script>
</body>
</html>
