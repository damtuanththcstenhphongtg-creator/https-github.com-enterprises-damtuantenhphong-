<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8">
<title>T·∫°o ƒë·ªÅ ki·ªÉm tra</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
<style>
  body {
    font-family: 'Roboto', sans-serif;
    background: #f4f6f9;
    margin: 0;
    padding: 20px;
  }
  h1 {
    text-align: center;
    color: #2c3e50;
  }
  .card {
    background: #fff;
    border-radius: 8px;
    padding: 20px;
    margin: 15px auto;
    max-width: 800px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  }
  label {
    display: block;
    margin: 10px 0 5px;
    font-weight: bold;
  }
  select, input {
    width: 100%;
    padding: 8px;
    border: 1px solid #ccc;
    border-radius: 6px;
  }
  .btn-group {
    text-align: center;
    margin-top: 20px;
  }
  button {
    background: #3498db;
    color: white;
    border: none;
    padding: 10px 18px;
    margin: 5px;
    border-radius: 6px;
    cursor: pointer;
    transition: 0.3s;
  }
  button:hover {
    background: #2980b9;
  }
  #container {
    margin-top: 20px;
    padding: 15px;
    background: #ecf0f1;
    border-radius: 8px;
    border: 1px solid #bdc3c7;
  }
  .question {
    margin-bottom: 15px;
    padding: 10px;
    background: #fff;
    border-left: 4px solid #3498db;
  }
  .section-title {
    font-size: 18px;
    font-weight: bold;
    margin-bottom: 15px;
    color: #2c3e50;
  }
</style>
</head>
<body>
<h1>üìò T·∫°o ƒë·ªÅ ki·ªÉm tra</h1>

<div class="card">
  <label>M√¥n h·ªçc:</label>
  <select id="subjectSelect">
    <option>To√°n</option>
    <option>Ng·ªØ vƒÉn</option>
    <option>Ti·∫øng Anh</option>
    <option>L·ªãch s·ª≠</option>
  </select>

  <label>L·ªõp:</label>
  <select id="gradeSelect">
    <option>6</option>
    <option>7</option>
    <option>8</option>
    <option>9</option>
  </select>

  <label>B√†i h·ªçc:</label>
  <select id="lessonSelect" multiple>
    <option>B√†i 1</option>
    <option>B√†i 2</option>
    <option>B√†i 3</option>
    <option>B√†i 4</option>
  </select>

  <label>Lo·∫°i ƒë·ªÅ:</label>
  <select id="examType">
    <option value="mcq">Ho√†n to√†n tr·∫Øc nghi·ªám</option>
    <option value="mix">Tr·∫Øc nghi·ªám + T·ª± lu·∫≠n</option>
    <option value="essay">Ho√†n to√†n t·ª± lu·∫≠n</option>
  </select>

  <label>S·ªë c√¢u m·ªói b√†i:</label>
  <input type="number" id="numEachInput" min="1" value="5">

  <label>S·ªë ƒë·ªÅ c·∫ßn t·∫°o:</label>
  <input type="number" id="numExamsInput" min="1" value="1">

  <div class="btn-group">
    <button id="generateBtn">üöÄ T·∫°o ƒë·ªÅ</button>
    <button id="previewBtn">üëÄ Xem tr∆∞·ªõc</button>
    <button id="exportWordBtn">üìÑ Xu·∫•t Word</button>
    <button id="exportJsonBtn">üíæ Xu·∫•t JSON</button>
  </div>
</div>

<div id="container"></div>

<!-- Th∆∞ vi·ªán -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/docx/8.3.2/docx.min.js"></script>

<script>
let generatedExams = [];

/* ================== T·∫†O ƒê·ªÄ ================== */
function generateExams() {
  const subject = subjectSelect.value;
  const grade = gradeSelect.value;
  const lessons = Array.from(lessonSelect.selectedOptions).map(o => o.value);
  const numEach = parseInt(numEachInput.value);
  const numExams = parseInt(numExamsInput.value);
  const examType = examTypeSelect.value;

  generatedExams = [];

  for (let i = 0; i < numExams; i++) {
    let exam = {
      subject, grade, examType,
      questions: []
    };

    lessons.forEach(lesson => {
      for (let j = 1; j <= numEach; j++) {

        if (examType !== "essay") {
          exam.questions.push({
            type: "mcq",
            content: `(${lesson}) C√¢u ${j}: N·ªôi dung tr·∫Øc nghi·ªám`,
            options: {
              A: "Ph∆∞∆°ng √°n A",
              B: "Ph∆∞∆°ng √°n B",
              C: "Ph∆∞∆°ng √°n C",
              D: "Ph∆∞∆°ng √°n D"
            }
          });
        }

        if (examType !== "mcq") {
          exam.questions.push({
            type: "essay",
            content: `(${lesson}) C√¢u ${j}: N·ªôi dung t·ª± lu·∫≠n`
          });
        }
      }
    });

    generatedExams.push(exam);
  }

  alert("ƒê√£ t·∫°o ƒë·ªÅ th√†nh c√¥ng!");
}

/* ================== XEM TR∆Ø·ªöC ================== */
function previewExams() {
  container.innerHTML = "";
  generatedExams.forEach((exam, idx) => {
    const div = document.createElement("div");
    div.innerHTML = `<div class="section-title">ƒê·ªÅ ${idx+1} ‚Äì ${exam.subject} ${exam.grade}</div>`;
    exam.questions.forEach(q => {
      const qd = document.createElement("div");
      qd.className = "question";
      if (q.type === "mcq") {
        qd.innerHTML = `<b>${q.content}</b><br>
          A. ${q.options.A}<br>
          B. ${q.options.B}<br>
          C. ${q.options.C}<br>
          D. ${q.options.D}`;
      } else {
        qd.innerHTML = `<b>${q.content}</b><br><i>(H·ªçc sinh t·ª± l√†m)</i>`;
      }
      div.appendChild(qd);
    });
    container.appendChild(div);
  });
}

/* ================== XU·∫§T WORD ================== */
async function exportWord() {
  const { Document, Packer, Paragraph, TextRun } = docx;

  const doc = new Document({
    sections: generatedExams.map((exam, idx) => ({
      children: [
        new Paragraph({
          children: [new TextRun({ text: `ƒê·ªÄ ${idx+1} ‚Äì ${exam.subject} ${exam.grade}`, bold:true, size:28 })]
        }),
        ...exam.questions.flatMap(q => {
          let arr = [new Paragraph(q.content)];
          if (q.type === "mcq") {
            Object.keys(q.options).forEach(k => {
              arr.push(new Paragraph(`${k}. ${q.options[k]}`));
            });
          } else {
            arr.push(new Paragraph(" "));
            arr.push(new Paragraph(" "));
          }
          return arr;
        })
      ]
    }))
  });

  const blob = await Packer.toBlob(doc);
  saveAs(blob, "De_Kiem_Tra.docx");
}

/* ================== XU·∫§T JSON ================== */
function exportJson() {
  saveAs(
    new Blob([JSON.stringify(generatedExams, null, 2)], { type:"application/json" }),
    "De_Kiem_Tra.json"
  );
}

/* ================== G√ÅN N√öT ================== */
const examTypeSelect = document.getElementById("examType");
const subjectSelect = document.getElementById("subjectSelect");
const gradeSelect = document.getElementById("gradeSelect");
const lessonSelect = document.getElementById("lessonSelect");
const numEachInput = document.getElementById("numEachInput");
const numExamsInput = document.getElementById("numExamsInput");
const container = document.getElementById("container");

generateBtn.onclick = generateExams;
previewBtn.onclick = previewExams;
exportWordBtn.onclick = exportWord;
exportJsonBtn.onclick = exportJson;
</script>
</body>
</html>