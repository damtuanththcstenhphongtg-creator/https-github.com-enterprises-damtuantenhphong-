<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>T·∫°o ƒë·ªÅ ki·ªÉm tra (phi√™n b·∫£n n√¢ng cao)</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body{font-family:Arial,Helvetica,sans-serif;background:#f0f3f7;margin:0;padding:20px}
.container{max-width:1000px;margin:0 auto;background:#fff;padding:18px;border-radius:8px;box-shadow:0 6px 18px rgba(0,0,0,.08)}
h2{margin-top:0}
.controls{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.controls > div{background:#fafafa;padding:10px;border-radius:6px;border:1px solid #eee}
label{display:block;font-weight:600;margin-bottom:6px}
input[type=file],select,input[type=number]{width:100%;padding:8px;border-radius:6px;border:1px solid #ccc}
button{padding:10px 14px;border-radius:6px;border:0;background:#1976d2;color:#fff;cursor:pointer}
button.secondary{background:#6c757d}
#previewExam{white-space:pre-wrap;background:#fbfbfb;padding:12px;border-radius:6px;border:1px solid #e6e6e6;margin-top:12px;min-height:160px}
.info{font-size:13px;color:#444;margin-top:8px}
.bad{color:#b00020;font-weight:700}
.good{color:#0a8a3a;font-weight:700}
.small{font-size:13px;color:#666}
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/docx/8.5.0/docx.min.js"></script>
</head>
<body>
<div class="container">
  <h2>üìù Teacher ‚Äì T·∫°o ƒë·ªÅ ki·ªÉm tra (h·ªó tr·ª£ nhi·ªÅu ƒë·ªãnh d·∫°ng JSON)</h2>

  <div class="controls">
    <div>
      <label>1) Ch·ªçn file JSON (upload)</label>
      <input type="file" id="jsonFile" accept=".json">
      <div id="loadResult" class="info small"></div>
      <div class="small" style="margin-top:8px">H·ªó tr·ª£: m·∫£ng c√¢u h·ªèi g·ªëc, object c√≥ key "questions", object theo b√†i, ho·∫∑c m·∫£ng c√¢u c√≥ field "lesson".</div>
    </div>

    <div>
      <label>2) C·∫•u h√¨nh t·∫°o ƒë·ªÅ</label>
      <label>Ch·ªçn B√†i:</label>
      <select id="lessonSelect"></select>

      <label>S·ªë c√¢u mu·ªën l·∫•y:</label>
      <input type="number" id="numQuestions" value="10" min="1">

      <label>T√πy ch·ªçn:</label>
      <label><input type="checkbox" id="shuffleQuestions" checked> ƒê·∫£o th·ª© t·ª± c√¢u</label><br>
      <label><input type="checkbox" id="shuffleOptions" checked> ƒê·∫£o ph∆∞∆°ng √°n A/B/C/D</label><br>

      <div style="margin-top:8px">
        <button id="btnGenerate">üé≤ T·∫°o ƒë·ªÅ</button>
        <button id="btnExport" class="secondary">üì• Xu·∫•t Word (.docx)</button>
      </div>
    </div>
  </div>

  <h3>üìÑ Xem tr∆∞·ªõc ƒë·ªÅ</h3>
  <div id="previewExam">Ch∆∞a c√≥ ƒë·ªÅ. T·∫£i file JSON r·ªìi nh·∫•n "T·∫°o ƒë·ªÅ".</div>

  <div id="debug" class="info"></div>
</div>

<script>
function $(id){return document.getElementById(id)}
function isObject(v){ return v && typeof v === 'object' && !Array.isArray(v); }

// =============================
// ‚≠ê AUTO-FIX & CHU·∫®N H√ìA M·ªòT C√ÇU H·ªéI
// =============================
function normalizeQuestion(q) {
  if (!q || typeof q !== 'object') return null;

  // === Auto-fix l·ªói ===
  if (q.answer && typeof q.answer === "string") {
    q.answer = q.answer.replace(".", "").trim().toUpperCase();
  }

  if (q.question && typeof q.question === "string") {
    q.question = q.question
      .replace(/^(C√¢u\s*\d+[:.)-]*)/i, "")
      .replace(/^\d+[.)-]\s*/, "")
      .trim();
  }

  ["A","B","C","D"].forEach(k => { if (!q[k]) q[k] = ""; });

  if (q.options && typeof q.options === "object") {
    ["A","B","C","D"].forEach(k => {
      if (!q.options[k] && !q.options[k.toLowerCase()]) q.options[k] = "";
    });
  }

  // === B·∫Øt ƒë·∫ßu normalize ===
  const out = {};
  out.id = q.id || q.no || q.index || null;
  out.question = q.question || q.text || q.prompt || "";

  // options
  let opts = { A: "", B: "", C: "", D: "" };
  if (q.options && Array.isArray(q.options)) {
    for (let i = 0; i < Math.min(q.options.length, 4); i++) {
      opts["ABCD"[i]] = String(q.options[i]);
    }
  } else if (isObject(q.options)) {
    for (const k of Object.keys(q.options)) {
      const K = k.toUpperCase();
      if ("ABCD".includes(K)) opts[K] = String(q.options[k]);
    }
  } else {
    ["A","B","C","D"].forEach(k => {
      if (q[k] !== undefined) opts[k] = String(q[k]);
    });
  }
  out.options = opts;

  // answer
  let ans = q.answer || q.correct || q.key || q.answerKey;
  if (typeof ans === 'number') {
    ans = "ABCD"[ans];
  } else if (typeof ans === 'string') {
    ans = ans.trim().toUpperCase();
    if (/^[0-9]+$/.test(ans)) ans = "ABCD"[parseInt(ans)];
  }
  out.answer = ans || "";

  out.raw = q;
  return out;
}

// =============================
// ‚≠ê CHU·∫®N HO√Å NG√ÇN H√ÄNG C√ÇU H·ªéI
// =============================
function normalizeQuestionBank(raw) {
  if (Array.isArray(raw)) {
    const haveLessonField = raw.every(q => q && (q.lesson || q.chapter || q.bai));
    if (haveLessonField) {
      const out = {};
      raw.forEach(q => {
        const lesson = q.lesson || q.chapter || q.bai || 'B√†i m·∫∑c ƒë·ªãnh';
        if (!out[lesson]) out[lesson] = { questions: [] };
        out[lesson].questions.push(normalizeQuestion(q));
      });
      return out;
    } else {
      return { "B√†i 1": { questions: raw.map(q => normalizeQuestion(q)) } };
    }
  }

  if (isObject(raw)) {
    if (raw.questions && Array.isArray(raw.questions)) {
      return { "B√†i 1": { questions: raw.questions.map(q => normalizeQuestion(q)) } };
    }

    const keys = Object.keys(raw);
    const out = {};
    let found = false;

    for (const k of keys) {
      const v = raw[k];
      if (Array.isArray(v)) {
        out[k] = { questions: v.map(q => normalizeQuestion(q)) };
        found = true;
      } else if (v && v.questions && Array.isArray(v.questions)) {
        out[k] = { questions: v.questions.map(q => normalizeQuestion(q)) };
        found = true;
      }
    }
    if (found) return out;

    if (raw.data && Array.isArray(raw.data.questions)) {
      return { "B√†i 1": { questions: raw.data.questions.map(q => normalizeQuestion(q)) } };
    }
  }

  return null;
}

// =============================
// ‚≠ê X·ª¨ L√ù T·∫¢I FILE JSON
// =============================
$('jsonFile').addEventListener('change', evt => {
  const f = evt.target.files && evt.target.files[0];
  if (!f) return;

  const reader = new FileReader();
  reader.onload = e => {
    try {
      const raw = JSON.parse(e.target.result);
      const norm = normalizeQuestionBank(raw);
      if (!norm) {
        $('loadResult').innerHTML =
          `<span class="bad">Kh√¥ng nh·∫≠n d·∫°ng ƒë∆∞·ª£c JSON.</span>`;
        return;
      }

      window.questionBank = norm;

      // c·∫≠p nh·∫≠t select
      const lessonSelect = $('lessonSelect');
      lessonSelect.innerHTML = "";
      const lessons = Object.keys(norm);
      lessons.forEach(name => {
        const opt = document.createElement("option");
        opt.value = name;
        opt.textContent = `${name} ‚Äî (${norm[name].questions.length} c√¢u)`;
        lessonSelect.appendChild(opt);
      });

      $('loadResult').innerHTML =
        `<span class="good">ƒê√£ load ${lessons.length} b√†i ‚Äî t·ªïng ${
          lessons.reduce((s, k) => s + norm[k].questions.length, 0)
        } c√¢u.</span>`;

      // ========== KI·ªÇM TRA L·ªñI =============
      let warn = [];
      lessons.forEach(lesson => {
        norm[lesson].questions.forEach((q, i) => {
          if (!q.question.trim()) warn.push(`‚Ä¢ ${lesson} ‚Äì C√¢u ${i+1}: thi·∫øu n·ªôi dung`);
          if (!q.options.A && !q.options.B && !q.options.C && !q.options.D)
            warn.push(`‚Ä¢ ${lesson} ‚Äì C√¢u ${i+1}: thi·∫øu ph∆∞∆°ng √°n`);
          if (!q.answer) warn.push(`‚Ä¢ ${lesson} ‚Äì C√¢u ${i+1}: thi·∫øu ƒë√°p √°n`);
        });
      });

      if (warn.length)
        $('debug').innerHTML = `<div class="bad">‚ö† JSON c√≥ ${warn.length} l·ªói:</div>${warn.join("<br>")}`;
      else
        $('debug').innerHTML = `<div class="good">‚úî JSON h·ª£p l·ªá.</div>`;

      window.normalizedQuestionBank = norm;

    } catch (err) {
      $('loadResult').innerHTML = `<span class="bad">L·ªói JSON: ${err.message}</span>`;
    }
  };
  reader.readAsText(f);
});

// =============================
// ‚≠ê T·∫†O ƒê·ªÄ
// =============================
$('btnGenerate').addEventListener('click', () => {
  if (!window.normalizedQuestionBank) {
    alert("Ch∆∞a t·∫£i JSON"); return;
  }

  const lesson = $('lessonSelect').value;
  const n = parseInt($('numQuestions').value);
  const shuffleQ = $('shuffleQuestions').checked;
  const shuffleOpt = $('shuffleOptions').checked;

  const pool = window.normalizedQuestionBank[lesson].questions;
  let arr = pool.slice();
  if (shuffleQ) arr.sort(() => Math.random() - 0.5);
  arr = arr.slice(0, n);

  const exam = { lesson, items: [] };
  let text = `ƒê·ªÄ KI·ªÇM TRA ‚Äî ${lesson}\n\n`;

  arr.forEach((q, idx) => {
    let opts = {...q.options};
    let correct = q.answer;

    if (shuffleOpt) {
      const labels = ["A","B","C","D"];
      const order = labels.sort(() => Math.random()-0.5);
      const newOpts = {};
      let newCorrect = "";

      order.forEach((orig, pos) => {
        const newLbl = labels[pos];
        newOpts[newLbl] = opts[orig];
        if (orig === correct) newCorrect = newLbl;
      });

      opts = newOpts;
      correct = newCorrect || correct;
    }

    exam.items.push({ no: idx+1, question: q.question, options: opts, answer: correct });

    text += `${idx+1}. ${q.question}\n`;
    text += `   A. ${opts.A}\n`;
    text += `   B. ${opts.B}\n`;
    text += `   C. ${opts.C}\n`;
    text += `   D. ${opts.D}\n\n`;
  });

  $('previewExam').textContent = text;
  window.currentExam = exam;
});

// =============================
// ‚≠ê XU·∫§T WORD
// =============================
$('btnExport').addEventListener('click', async ()=>{
  if (!window.currentExam) { alert("Ch∆∞a c√≥ ƒë·ªÅ"); return; }

  const { Document, Packer, Paragraph, TextRun } = docx;
  const children = [];

  children.push(new Paragraph({
    children: [ new TextRun({ text:`ƒê·ªÄ KI·ªÇM TRA ‚Äî ${window.currentExam.lesson}`, bold:true, size:28 }) ],
    spacing:{ after:300 }
  }));

  window.currentExam.items.forEach(item=>{
    children.push(new Paragraph({
      children:[ new TextRun(`${item.no}. ${item.question}`) ]
    }));
    ["A","B","C","D"].forEach(lbl=>{
      children.push(new Paragraph({ children:[ new TextRun(`   ${lbl}. ${item.options[lbl]}`) ] }));
    });
    children.push(new Paragraph(""));
  });

  children.push(new Paragraph({
    children:[ new TextRun({ text:"\n\nB·∫¢NG ƒê√ÅP √ÅN", bold:true, size:24 }) ],
    spacing:{ before:300 }
  }));

  window.currentExam.items.forEach(item=>{
    children.push(new Paragraph(`C√¢u ${item.no}: ${item.answer}`));
  });

  const doc = new Document({ sections:[{ children }] });
  const blob = await Packer.toBlob(doc);
  saveAs(blob, `De_${window.currentExam.lesson.replace(/\s+/g,"_")}.docx`);
});
</script>
</body>
</html>
