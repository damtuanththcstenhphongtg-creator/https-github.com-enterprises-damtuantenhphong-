<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>N·ªôp b√†i h·ªçc sinh</title>
<style>
body{font-family:"Segoe UI",sans-serif;margin:20px;background:#eef3f7;}
h1{text-align:center;color:#0a4a8e;}
label{display:block;margin-top:10px;font-weight:600;}
input,select{width:100%;padding:8px;margin-top:5px;border-radius:6px;border:1px solid #ccc;}
button{margin-top:15px;padding:10px 18px;background:#0b74d1;color:#fff;border:none;border-radius:6px;cursor:pointer;}
button:hover{background:#095ba8;}
.success{background:#e1fbd8;padding:12px;border-left:5px solid #4caf50;margin-top:10px;border-radius:6px;}
.error{background:#ffe2e2;padding:12px;border-left:5px solid #e53935;margin-top:10px;border-radius:6px;}
</style>
</head>
<body>

<h1>üì§ N·ªôp b√†i h·ªçc sinh</h1>

<div id="msg"></div>

<label>Ch·ªçn l·ªõp:</label>
<select id="classSelect"></select>

<label>Ch·ªçn ƒë·ªÅ:</label>
<select id="examSelect"></select>

<label>Ch·ªçn file n·ªôp:</label>
<input type="file" id="fileInput">

<button onclick="submitExam()">N·ªôp b√†i</button>

<script>
if(localStorage.getItem("role")!=="student"){ alert("B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p!"); window.location.href="index.html"; }

async function loadAssignments(){
    const cls = document.getElementById("classSelect");
    const exam = document.getElementById("examSelect");
    cls.innerHTML=""; exam.innerHTML="";
    const res = await fetch("/assignments");
    const assignments = await res.json();
    const classes = [...new Set(assignments.map(a=>a.class))];
    classes.forEach(c=>cls.innerHTML+=`<option value="${c}">${c}</option>`);
    updateExams();
}

async function updateExams(){
    const cls = document.getElementById("classSelect").value;
    const exam = document.getElementById("examSelect");
    exam.innerHTML="";
    const res = await fetch("/assignments");
    const assignments = await res.json();
    assignments.filter(a=>a.class===cls).forEach(a=>{
        exam.innerHTML+=`<option value="${a.examId}">${a.examTitle}</option>`;
    });
}

document.getElementById("classSelect").addEventListener("change",updateExams);

async function submitExam(){
    const student = localStorage.getItem("username")||"H·ªçc sinh";
    const className = document.getElementById("classSelect").value;
    const examId = document.getElementById("examSelect").value;
    const fileInput = document.getElementById("fileInput");
    const msg = document.getElementById("msg");

    if(!fileInput.files.length){ msg.innerHTML=`<div class="error">‚ö†Ô∏è Ch∆∞a ch·ªçn file!</div>`; return; }

    const formData = new FormData();
    formData.append("student",student);
    formData.append("className",className);
    formData.append("examId",examId);
    formData.append("file",fileInput.files[0]);

    const res = await fetch("/submit",{method:"POST",body:formData});
    const result = await res.json();
    if(res.ok){ msg.innerHTML=`<div class="success">‚úÖ ${result.message}</div>`; fileInput.value=""; }
    else{ msg.innerHTML=`<div class="error">‚ùå ${result.error}</div>`; }
}

loadAssignments();
</script>

</body>
</html>
